<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Source Fold</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      #markdownPreview p code{
        color:red;
        background: rgba(0, 0, 0, 0.03);
        font-family: monospace;
        border-radius: 4px;
        padding: 0px 4px;
      }

      #markdownPreview pre code {
        display: block;
        background: rgba(0, 0, 0, 0.03);
        padding: 6px;
        border-radius: 6px;
      }
      body {
        background: linear-gradient(to right, #e0f7fa, #fff3e0);
        min-height: 100vh;
      }
      .glass {
        background: rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 1rem;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      }
      input[type="file"]::file-selector-button {
        background: rgba(255, 255, 255, 0.4);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      input[type="file"]::file-selector-button:hover {
        background: linear-gradient(135deg, #9be7ff, #ffe0b2);
        color: #000;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      textarea,
      input[type="file"],
      button,
      a {
        transition: all 0.3s ease;
      }
      button:hover,
      a:hover,
      textarea:hover {
        background: linear-gradient(135deg, #9be7ff, #ffe0b2);
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>
  <body class="text-gray-800">
    <script>
      const API_UPLOAD = "/upload/";
      const API_MARKDOWN = "/markdown/";
      const API_DOWNLOAD = "/download/";
    </script>

    <main class="max-w-6xl p-10 mx-auto space-y-10">
      <!-- Section 1: Upload -->
      <section class="p-6 glass">
        <h2 class="mb-4 text-2xl font-bold">1. Upload Codebase (ZIP)</h2>
        <form id="uploadForm" class="flex flex-col items-start space-y-4 md:flex-row md:items-center md:space-y-0 md:space-x-4">
          <input type="file" name="file" accept=".zip" class="p-2 border rounded cursor-pointer bg-white/50" required />
          <button type="submit" class="px-4 py-2 text-white bg-blue-600 rounded shadow hover:scale-105">Upload</button>
        </form>
      </section>

      <!-- Section 2: Regex & Tree View -->
      <section id="section2" class="hidden p-6 glass">
        <h2 class="mb-4 text-2xl font-bold">2. Filter & Fold</h2>
        <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
          <!-- Left: Regex Inputs -->
          <div>
            <label class="block mb-2 font-semibold">Include Regex (comma separated)</label>
            <textarea id="includeRegex" class="w-full p-2 border rounded bg-white/50 mb-4 h-24 hover:scale-[1.01] focus:outline-none"></textarea>

            <label class="block mb-2 font-semibold">Exclude Regex (comma separated)</label>
            <textarea id="excludeRegex" class="w-full p-2 border rounded bg-white/50 mb-4 h-24 hover:scale-[1.01] focus:outline-none"></textarea>

            <button id="foldBtn" class="px-4 py-2 text-white bg-green-600 rounded shadow hover:scale-105">Fold</button>
          </div>

          <!-- Right: File Tree -->
          <div>
            <h3 class="mb-2 font-semibold">File Structure</h3>
            <div id="fileTree" class="bg-white/50 p-4 border rounded h-[300px] overflow-auto text-sm font-mono"></div>
          </div>
        </div>
      </section>

      <!-- Section 3: Markdown Output -->
      <section id="section3" class="hidden p-6 glass">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold">3. Output Markdown</h2>
          <div class="space-x-2">
            <button id="copyBtn" class="px-4 py-2 text-white bg-gray-800 rounded shadow hover:scale-105">Copy</button>
            <a id="downloadBtn" href="#" download class="px-4 py-2 text-white bg-blue-600 rounded shadow hover:scale-105">Download</a>
          </div>
        </div>
        <div id="markdownPreview" class="bg-white/50 border p-4 h-[400px] overflow-auto whitespace-pre-wrap rounded text-sm font-mono prose max-w-none"></div>
      </section>
    </main>

    <script>
      let fileUUID = null;
      const uploadForm = document.getElementById("uploadForm");
      const fileTree = document.getElementById("fileTree");
      const markdownPreview = document.getElementById("markdownPreview");
      const includeRegex = document.getElementById("includeRegex");
      const excludeRegex = document.getElementById("excludeRegex");

      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(uploadForm);
        const res = await fetch(API_UPLOAD, {
          method: "POST",
          body: formData,
        });
        const data = await res.json();
        fileUUID = data.uuid;
        renderTree(data.structure);
        document.getElementById("section2").classList.remove("hidden");
      });

      function renderTree(structure, prefix = "") {
        fileTree.innerHTML = "";
        const walker = (node, depth = 0) => {
          const color = node.children ? "text-yellow-500" : node.is_text ? "text-green-700" : "text-red-600";
          fileTree.innerHTML += `<div class='pl-${depth * 4} ${color}'>${prefix + node.name}</div>`;
          if (node.children) {
            node.children.forEach((child) => walker(child, depth + 1));
          }
        };
        walker(structure);
      }

      document.getElementById("foldBtn").addEventListener("click", async () => {
        const payload = {
          uuid: fileUUID,
          include_regex: includeRegex.value || null,
          exclude_regex: excludeRegex.value || null,
        };
        const res = await fetch(API_MARKDOWN, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const markdown = await res.text();

        if (markdown.length > 65 * 1024) {
          markdownPreview.innerHTML = "<p>Markdown too large to preview.</p>";
          document.getElementById("copyBtn").classList.add("hidden");
        } else {
          markdownPreview.innerHTML = marked.parse(markdown);
          document.getElementById("copyBtn").classList.remove("hidden");
        }
        document.getElementById("section3").classList.remove("hidden");
        document.getElementById("downloadBtn").href = `${API_DOWNLOAD}${fileUUID}/output.md`;
      });

      document.getElementById("copyBtn").addEventListener("click", () => {
        navigator.clipboard.writeText(markdownPreview.textConten);
      });
    </script>
  </body>
</html>
